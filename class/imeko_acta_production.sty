%%% ACTA IMEKO Latex class file - Extra functions
%% imeko_acta_production.sty
%%
%% Vers: 1.9
%% By: Federico Tramarin (tramarin@unimore.it)
%% Date: 22/02/2024
%% Notes: Rewrote the code for producing the bibliography, now with bib labels hanged on the left
%%		Added the \AIBreakAtRef command to equalize last column
%%		Automatic aletrnate row coloring
%%
%% Copyright (c) 2024 Federico Tramarin
%% 
%%*************************************************************************
%% Legal Notice:
%% This code is offered as-is without any warranty either expressed or
%% implied; without even the implied warranty of MERCHANTABILITY or
%% FITNESS FOR A PARTICULAR PURPOSE! 
%% User assumes all risk.
%% In no event shall the Acta Imeko or any contributor to this code be liable for
%% any damages or losses, including, but not limited to, incidental,
%% consequential, or any other damages, resulting from the use or misuse
%% of any information contained here.
%% All comments are the opinions of their respective authors and are not
%% necessarily endorsed by the Acta Imeko or Imeko.
%
% This work may be distributed and/or modified under the
% conditions of the LaTeX Project Public License, either version 1.3
% of this license or (at your option) any later version.
% The latest version of this license is in
%   https://www.latex-project.org/lppl.txt
% and version 1.3c or later is part of all distributions of LaTeX
% version 2008 or later.
%
% This work has the LPPL maintenance status `maintained'.
% 
% The Current Maintainer of this work is Federico Tramarin.
%
% This work consists of the files imeko_acta.cls, imeko_acta.bst
% and the derived file imeko_acta_template.tex and guide.tex
%
%% Retain all contribution notices and credits.
%% ** Modified files should be clearly indicated as such, including  **
%% ** renaming them and changing author support contact information. **
%%*************************************************************************
\NeedsTeXFormat{LaTeX2e}
\ProvidesClass{imeko_acta_production}[2024/02/08 Acta Imeko paper class v1.8]

\ifxetex
	\RequirePackage{fontspec,unicode-math}
	\setsansfont{Calibri}
	\setmathfont{Cambria Math}
\fi

\ifpdf
	
\fi
\ifLuaTeX
	\RequirePackage{fontspec,unicode-math}
	\setsansfont{Calibri}
	\setmathfont{Cambria Math}
	\microtypesetup{tracking=normalfont,expansion}
	\SetTracking[ spacing = {25*,350, } ]{ encoding = * }{ 20 }
	% \DeclareMicrotypeSet*[tracking]{myset}{encoding = *, family = sf*}
	% \SetTracking[ spacing = {25*,350, } ]{ encoding = *, family = sf* }{ 100 }
\fi

\newif\ifuseexplthreefunctions \useexplthreefunctionsfalse
\IfFileExists{expl3.sty}{%
  \global\useexplthreefunctionstrue%
  \RequirePackage{expl3}}{}
\ifuseexplthreefunctions\relax%
\IfFileExists{xparse.sty}{\RequirePackage{xparse}}{}
\IfFileExists{etoolbox.sty}{\RequirePackage{etoolbox}}{}
\fi

\ifuseexplthreefunctions\relax%
\ExplSyntaxOn
\keys_define:nn { ai / author }{ 
	name .code:n = \csgappto { authorlongname } {#1\mbox{~}%
											\unskip\ignorespaces}, 
	surname .code:n = \csgappto { authorlongname } {#1} , 
	abbreviated .code:n= \csgappto { authorshortname } {#1}, 
	}

	\DeclareDocumentCommand\authorii{ o m }{
		\csgdef { authorlongname3 } { }
		\csgdef { authorshortname3 } { }
		\IfNoValueTF { #2 }
		  { }
		  {
		   \keys_set:nn { ai / author } { #2 }
		  }

		  \csgappto{AIauthorString}{%
		  \def\baselinestretch{1}%
		  \refstepcounter{auth}% increment by 1
		  \newif\ifnotyetprocessed% this if is needed to check if this author has already been counted for corresponding
		  \notyetprocessedtrue
		  \authorsep#2\unskip\textsuperscript{%
				\@for\@@affmark:=#1\do{%
				  %\typeout{Federico - @@author macro -> auth:\theauth\ affmark:\@@affmark - author:#1}
					 \edef\affnum{\@ifundefined{X@\@@affmark}{affn?}{\AIrefMark{\@@affmark}}}%
				   \unskip\sep\affnum%
				  \ifnotyetprocessed%
					  \NewAIaffLabel{auth-\theauth}{+}%
				   \fi%.
				  \edef\cormark{\@ifundefined{X@cor-\theauth}{}{%
					  \if@showcorr
						  {,\AIrefMark{cor-\theauth}}%
					  \else
						  {}%
					  \fi}}%
				  %			\unskip\sep\cormark\let\sep=,% this line was wrong, since it will add a extra comma in case of multiple affiliations
				  \unskip\cormark\let\sep=,% now the issue is for the corresponding author with multiple affiliations
				  \ifx\cormark\@empty%
				  \else
					  \ifnotyetprocessed% if the author is corresponding and is the first time we are here
						  \g@addto@macro\@CorrespondingAuthorName{#2}% add the author name to the output
						  \notyetprocessedfalse %if it is a subsequent round, do nothing
					  \fi
				  \fi
				  }%
				}%
		  \gdef\authorsep{\unskip,\space}%
		  \global\let\sep\@empty%
		  }
		  \csxappto{authtesti}{
			\csuse { authorlongname3 },\space\csuse { authorshortname3 }
			\par
		  }
	  }
	\DeclareDocumentCommand\printauthi{}{\authtesti}

\ExplSyntaxOff
\fi

\endinput

